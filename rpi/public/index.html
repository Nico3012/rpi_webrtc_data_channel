<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPI WebRTC Server</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>    <div class="container">
        <h1>ðŸ¥§ RPI WebRTC Server</h1>
        
        <!-- Step 1: Paste Offer -->
        <div id="step1" class="step-container">
            <div class="step-header">
                <h2>Step 1: Paste SDP Offer</h2>
                <div class="step-indicator">1 / 2</div>
            </div>
            <p>Paste the SDP offer you copied from the web client:</p>
            <input type="text" id="offerInput" placeholder="Paste the SDP offer JSON here...">
            <button id="generateAnswerBtn" class="btn btn-primary">Generate Answer</button>
        </div>
        
        <!-- Step 2: Copy Answer -->
        <div id="step2" class="step-container hidden">
            <div class="step-header">
                <h2>Step 2: Copy SDP Answer</h2>
                <div class="step-indicator">2 / 2</div>
            </div>
            <div class="status success">
                âœ… SDP Answer Generated Successfully!
            </div>
            <p>Copy the answer below and paste it back into the web client:</p>
            <div class="input-group">
                <input type="text" id="answerDisplay" readonly>
                <button id="copyAnswerBtn" class="btn btn-success">Copy Answer</button>
            </div>
            <button id="closePageBtn" class="btn btn-secondary">Close Page</button>
            <p class="help-text">Click "Copy Answer" to copy the answer to your clipboard, then "Close Page" to close this tab.</p>
        </div>
        
        <div id="errorSection" class="hidden">
            <div class="status error">
                <span id="errorMessage"></span>
            </div>
        </div>
    </div>

    <script>
        async function generateAnswer() {
            const offerInput = document.getElementById('offerInput');
            const offerText = offerInput.value.trim();
            
            if (!offerText) {
                showError('Please paste the SDP offer first');
                return;
            }
            
            try {
                // Parse the offer JSON
                const offer = JSON.parse(offerText);
                
                // Validate offer structure
                if (!offer.type || !offer.sdp || offer.type !== 'offer') {
                    throw new Error('Invalid offer format. Expected an offer with type and sdp properties.');
                }
                
                // Disable button during processing
                const btn = document.getElementById('generateAnswerBtn');
                btn.disabled = true;
                btn.textContent = 'Processing...';
                
                // Send offer to RPI server API
                const response = await fetch('/api/offer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(offer)
                });
                
                const result = await response.json();
                
                if (!response.ok || result.error) {
                    throw new Error(result.error || 'Failed to generate answer');
                }
                
                // Display the answer as JSON (compact format for single line)
                document.getElementById('answerDisplay').value = JSON.stringify(result);
                showStep(2);
                
            } catch (error) {
                console.error('Error generating answer:', error);
                showError('Error generating answer: ' + error.message);
            } finally {
                // Re-enable button
                const btn = document.getElementById('generateAnswerBtn');
                btn.disabled = false;
                btn.textContent = 'Generate Answer';
            }
        }
        
        function copyAnswer() {
            const answerInput = document.getElementById('answerDisplay');
            answerInput.select();
            answerInput.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                
                const btn = document.getElementById('copyAnswerBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.backgroundColor = '#218838';
                
                // Reset button text after 2 seconds
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = '#28a745';
                }, 2000);
                
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                alert('Failed to copy to clipboard. Please select and copy manually.');
            }
        }
        
        function closePage() {
            window.close();
        }
        
        function showStep(stepNumber) {
            // Hide all steps
            for (let i = 1; i <= 2; i++) {
                const step = document.getElementById(`step${i}`);
                if (step) {
                    step.classList.add('hidden');
                }
            }
            
            // Show current step
            const currentStep = document.getElementById(`step${stepNumber}`);
            if (currentStep) {
                currentStep.classList.remove('hidden');
            }
            
            // Hide error section when showing a step
            document.getElementById('errorSection').classList.add('hidden');
        }
        
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorSection').classList.remove('hidden');
        }
        
        // Set up event listeners
        window.addEventListener('load', () => {
            document.getElementById('generateAnswerBtn').addEventListener('click', generateAnswer);
            document.getElementById('copyAnswerBtn').addEventListener('click', copyAnswer);
            document.getElementById('closePageBtn').addEventListener('click', closePage);
            showStep(1); // Start with step 1
        });
    </script>
</body>
</html>
